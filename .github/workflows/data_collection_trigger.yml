name: Daily Data Collection Trigger

on:
  schedule:
    # Runs every day at 01:00 UTC (9 AM Beijing Time)
    - cron: '0 1 * * *'
  workflow_dispatch:
    # Allows manual triggering from the GitHub Actions tab

jobs:
  trigger_space:
    runs-on: ubuntu-latest
    steps:
      - name: Send trigger to Hugging Face Space
        env:
          HF_SPACE_URL: ${{ secrets.HF_SPACE_URL }}
          HF_RUN_KEY: ${{ secrets.HF_RUN_KEY }}
        run: |
          # Remove trailing slashes from the base URL
          BASE_URL=$(echo $HF_SPACE_URL | sed 's:/*$::')
          
          echo "Attempting to trigger data collection at Hugging Face Space: $BASE_URL"
          
          # Use /run/run_collector for the Gradio API endpoint
          response=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"data\": [\"$HF_RUN_KEY\"]}" \
            "${BASE_URL}/run/run_collector")
          
          echo "Response from Space:"
          echo "$response"
          
          # Enhanced error checking: Catch generic Gradio HTTP errors
          if echo "$response" | grep -q "\"error\""; then
            echo "Error: Server returned an HTTP error. See response above."
            exit 1
          # Catch custom Python script errors
          elif echo "$response" | grep -q "Auth failed: Incorrect secret key!"; then
            echo "Error: Authentication failed. Check HF_RUN_KEY secret."
            exit 1
          elif echo "$response" | grep -q "Execution error"; then
            echo "Error: Script execution failed on Space. Check Space logs."
            exit 1
          else
            echo "Successfully triggered data collection."
          fi
