name: Daily Data Collection Trigger

on:
  schedule:
    # Runs every day at 01:00 UTC (9 AM Beijing Time)
    - cron: '0 1 * * *'
  workflow_dispatch:
    # Allows manual triggering from the GitHub Actions tab

jobs:
  trigger_space:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install gradio_client
        run: pip install gradio_client

      - name: Trigger Hugging Face Space API
        env:
          HF_SPACE_ID: "Yanbo2/Compute-and-Token-Watch" 
          HF_RUN_KEY: ${{ secrets.HF_RUN_KEY }}
        run: |
          python -c "
          from gradio_client import Client
          import os
          import sys

          space_id = os.environ.get('HF_SPACE_ID')
          run_key = os.environ.get('HF_RUN_KEY')

          print(f'Connecting to Hugging Face Space: {space_id}')
          
          try:
              # Initialize the client. This automatically resolves the correct underlying URL.
              client = Client(space_id)
              
              print('Triggering data collection...')
              
              # Call the hidden API endpoint defined in app.py
              result = client.predict(
                  secret_key=run_key,
                  api_name='/run_collector'
              )
              
              print(f'Response from Space:\n{result}')
              
              # Validate the response string against our known custom error messages
              if 'Auth failed' in str(result) or 'Execution error' in str(result):
                  print('Error: Job failed inside the Space. Check logs above.')
                  sys.exit(1)
              else:
                  print('Success! Data collection triggered perfectly.')
                  
          except Exception as e:
              print(f'Critical Error connecting or running API: {e}')
              sys.exit(1)
          "
